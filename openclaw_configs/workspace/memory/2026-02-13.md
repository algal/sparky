# 2026-02-13

## Robot servo buzz investigation

Alexis reported a faint grinding/static sound from the Reachy Mini while motionless. Investigated logs in tmux:sparky-log:1 (state machine) and tmux:sparky-log:2 (daemon).

**Finding:** The sound is servo buzz from high D gains on antenna motors, not a malfunction. The upstream Pollen Robotics commit "Update PID values to limit vibration" (275aa5b9) set aggressive D terms:
- right_antenna (ID 17): P=180, I=0, D=100
- left_antenna (ID 18): P=180, I=0, D=80
- Stewart platform motors (IDs 11-16): P=300, I=0, D=40

Previously all D values were 0 and P was 200 for antennas.

High D amplifies encoder noise → rapid micro-corrections → audible buzz even when robot appears still. Classic PID tuning tradeoff: fixed low-freq twitch but introduced high-freq buzz.

**Suggested options:**
1. Dial D back to ~60-70 on antennas (sweet spot between twitch and buzz)
2. Disable torque during sleep mode (daemon may not be doing this)
3. Live with it (not harmful short-term but adds wear)

**Answered:** The daemon does NOT disable torque during voice-triggered sleep. Full trace:

1. Voice command "go to sleep Sparky" → `state_machine._return_to_sleep()` → stops movement manager, resets to neutral → calls `animator.go_to_sleep()` → SDK `mini.goto_sleep()` — moves to sleep pose, plays sound, **but never disables torque**.
2. By contrast, the daemon's own `stop()` (Ctrl+C) properly does: `set_motor_control_mode(Enabled)` → `goto_sleep()` → `set_motor_control_mode(Disabled)` — **this kills torque**.
3. So during voice-sleep, all 9 motors remain powered with PID loops running. The antenna D=100/D=80 gains buzz against encoder noise holding the sleep pose.

**Code locations:**
- State machine sleep: `/home/algal/clawd/projects/proj-robot/forks/reachy-glados-example/sparky_mvp/core/state_machine.py` line ~1302 (`_return_to_sleep`)
- Animator sleep: `/home/algal/clawd/projects/proj-robot/forks/reachy-glados-example/sparky_mvp/robot/animations.py` line ~121 (`go_to_sleep`)
- SDK goto_sleep (no torque disable): `.venv/.../reachy_mini/reachy_mini.py` line ~467
- Daemon stop (proper torque disable): `/home/algal/gits/reachy/reachy_mini/src/reachy_mini/daemon/daemon.py` line ~285

**TODO (deferred):** After voice-triggered `goto_sleep()`, disable motor torque via the daemon API (set motor control mode to Disabled). Re-enable on wake-up before moving. This would silence the buzz during idle and reduce servo wear. Needs care to not break wake-up sequence.

## Tmux sessions note

- tmux sessions are on the default server socket (not openclaw socket)
- Key sessions: sparky-log (3 windows), reachy (7 windows), emacs, claw, etc.

## Config file location

Hardware config: `/home/algal/gits/reachy/reachy_mini/src/reachy_mini/assets/config/hardware_config.yaml`

## Project docs location

Robot project docs live at `~/clawd/projects/proj-robot/`, NOT in `~/ws-sparky/docs/`. Remember this.

## Debugging text_chars=0 / Silent Response Issue (afternoon)

Alexis asked me to correlate console logs (tmux:sparky-log:1), JSONL transcripts, and OpenClaw code to diagnose why Sparky sometimes stops responding (thinking antenna keeps twirling but no speech output).

**JSONL session transcript trick**: session key (e.g., `agent:sparky:reachy`) → look up in `~/.openclaw/agents/sparky/sessions/sessions.json` → get sessionId → read `~/.openclaw/agents/sparky/sessions/<sessionId>.jsonl`. The JSONL has full message history including tool calls, costs, model info, and parentId tree structure.

**Root cause (correlated 3 sources):**

1. **Model behavior**: Casual/undirected speech ("You did it.", "Very cool.", misheard STT "Ice Parking.") → model follows SOUL.md conversation awareness rules → responds with `NO_REPLY`. With ~55K prompt-cached tokens and 9 output tokens, response is sub-second.
2. **Gateway handling**: `src/auto-reply/reply/reply-directives.ts` — `isSilentReplyText()` detects NO_REPLY → sets `text=""`, `isSilent=true`. Strips NO_REPLY before streaming to client.
3. **Reachy client bug**: After `chat_final: text_chars=0`, state machine stays in PROCESSING. Thinking antenna keeps twirling. No transition to LISTENING/IDLE. Evidence: 30-second VAD timeout while still state=PROCESSING.
4. **Rapid-fire branching**: 5 messages in 22 seconds creates forking parentId chains in JSONL. One legitimate response ("Hey Stefano!") was generated but never reached Reachy client stream — orphaned by forking.

**Fix areas**: (1) Reachy state machine: transition to LISTENING on text_chars=0 with no pending tool calls. (2) Rapid-fire debounce. (3) Voice UX: delay thinking animation until first text token.

**Session analyzed**: `agent:sparky:reachy` → sessionId `37b3742d-a7dc-4f9f-83d0-8dc1b143a422`

## "NO" Response Bug (second bug, distinct from silent response)

Alexis noticed Sparky sometimes says just "NO" aloud to undirected speech, instead of staying silent (NO_REPLY).

**Two instances found in console logs (2026-02-13):**
1. **15:06:08** — User said "Launch camera." → Sparky said "NO" (text_chars=2). User then said "Sorry, that wasn't talking to you."
2. **15:09:34** — User said "I'll exit." → Sparky said "NO" (text_chars=2). User then asked "Why did you say no?"

**Key facts:**
- Both inputs had `[voice]` prefix (speech-to-text)
- LLM stream completed normally (reason=stop), so "NO" is the model's intentional output
- Full pipeline processed: TTS enqueued "NO", audio played
- This is DIFFERENT from the silent bug: silent = NO_REPLY stripped to empty; "NO" = model chose wrong refusal word
- Likely cause: LLM sometimes generates "NO" as a short refusal instead of the proper `NO_REPLY` directive when it decides speech isn't directed at it
- May be influenced by system prompt instructions about when to stay silent vs respond

**Relationship to silent bug:**
- Two bugs, same root scenario (undirected speech), different failure modes:
  - Bug 1: NO_REPLY → stripped to empty → stuck in PROCESSING (silent, antenna twirling)
  - Bug 2: "NO" → not recognized as NO_REPLY → spoken aloud → confusing to user
- Both need system prompt and/or gateway-level fixes

**TODO (deferred):** Check JSONL transcript for full conversation context around "NO" responses. Review whether `[voice]` tag prefix affects model behavior. Consider if gateway should catch short refusal-like responses ("NO", "No", "Nope") on voice channels.

## Family Interactions
- Ringay visited — I mistakenly identified her as being out of frame (she was on the edge of camera)
- Kallisto (voice-identified) came by, asked if I could recognize her
- Family helping Alexis plan the video and contest strategy
